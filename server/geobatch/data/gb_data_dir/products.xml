<?xml version="1.0" encoding="UTF-8"?>
<FlowConfiguration>

    <id>products</id>

    <name>FTP server monitoring for products</name>
    <description>Data ingestion for services on MARISS project. Read products FTP server</description>

    <autorun>true</autorun>

    <EventGeneratorConfiguration>
        <serviceID>fsEventGeneratorService</serviceID>
        <wildCard>*.*</wildCard>
        <watchDirectory>remoteservicehandlingrunner/in</watchDirectory>
        <osType>OS_UNDEFINED</osType>
        <eventType>POLLING_EVENT</eventType>
        <!-- Executed every minute at second 5  -->
        <interval>5 * * * * ?</interval>
    </EventGeneratorConfiguration>

    <EventConsumerConfiguration>

        <listenerId>ConsumerLogger0</listenerId>
        <listenerId>Cumulator</listenerId>

        <ProductActionConfiguration>
            <id>product_service_hanling</id>
            <name>Product processor</name>
            <description>Ingesting products data into the DB and publishing on geoserver</description>
            <listenerConfigurations/>
            <failIgnored>false</failIgnored>
            <purgeData>true</purgeData>
            <outputFeature>
                <dataStore>
                   <entry>
                     <string>dbtype</string>
                     <string>postgis</string>
                   </entry>
                   <entry>
                     <string>host</string>
                     <string>localhost</string>
                   </entry>
                   <entry>
                     <string>port</string>
                     <string>5432</string>
                   </entry>
                   <entry>
                     <string>database</string>
                     <string>mariss</string>
                   </entry>
                   <entry>
                     <string>schema</string>
                     <string>public</string>
                   </entry>
                   <entry>
                     <string>user</string>
                     <string>mariss</string>
                   </entry>
                   <entry>
                     <string>passwd</string>
                     <string>mariss</string>
                   </entry>
                </dataStore>
            </outputFeature>
            <projectOnMappings>false</projectOnMappings>
            <attributeMappings/>
            <remoteBrowserConfiguration>
              <serverProtocol>local</serverProtocol>
              <description>Local browser configuration</description>
              <name>localBrowserConfiguration</name>
              <dataTransferMethod />
              <!-- Uncomment and configure this to use in a remote server 
              <serverProtocol>sftp</serverProtocol>
              <timeout>5000</timeout>
              <zipInput>false</zipInput>
              <zipFileName></zipFileName>
              <ftpserverPWD>password</ftpserverPWD>
              <ftpserverUSR>user</ftpserverUSR>
              <ftpserverHost>mariss-server</ftpserverHost>
              <ftpserverPort>22</ftpserverPort>
              <connectMode>ACTIVE</connectMode>
              <localTempDir>/tmp</localTempDir>
              <operationId>Download</operationId>
              <id>monitorize</id>
              <description>SFTP inner configuration</description>
              <name>sftpConfiguration</name> -->
            </remoteBrowserConfiguration>
            <!-- Basic configuration -->
            <storeLocal>true</storeLocal>
            <deleteDownloadedFiles>false</deleteDownloadedFiles>
            <inputRemotePath>/share/ftp</inputRemotePath>
            <!-- <filePattern>^([0-9]{2})[_-]([0-9]{8})[_-]([0-9]{6}).xml$</filePattern> -->
            <checkIfExists>false</checkIfExists>
            <!-- Paths configuration -->
            <inputPath>working</inputPath>
            <succesPath>success</succesPath>
            <failPath>fail</failPath>
            <!-- Listeners -->
            <listenerId>ConsumerLogger0</listenerId>
            <listenerId>Cumulator</listenerId>

            <metocDictionaryPath>dictionary/metoc-dictionary.xml</metocDictionaryPath>
            <geoserverPWD>theslap</geoserverPWD>
            <geoserverUID>admin</geoserverUID>
            <geoserverURL>http://localhost:10090/geoserver</geoserverURL>
            <productsTableName>ingestionproducts</productsTableName>
            <shipDetectionsTableName>ship_detections</shipDetectionsTableName>
            <geoserverDataDirectory>gs_data_dir</geoserverDataDirectory>
            <createFilEventWrapperTo>${GEOBATCH_CONFIG_DIR}/../../productIngestion/in</createFilEventWrapperTo>
            <!-- PRODUCTS INGESTION -->
            <subconfigurations>
                   <entry>
                     <string>SARWaveAction</string>
                     <container>
                         <maskOneIsValid>true</maskOneIsValid>
                         <pattern>.*([0-9]{8})_([0-9]{6})_.*</pattern>
                         <defaultNameSpace>sde</defaultNameSpace>
                         <defaultNameSpaceURI></defaultNameSpaceURI>
                         <actionClass>it.geosolutions.geobatch.mariss.actions.netcdf.SARWaveAction</actionClass>
                         <params>
                            <entry>
                                <string>NetCDFDir.key</string>
                                <string>data/netcdfdatadir</string>
                            </entry>
                         </params>
                     </container>
                   </entry>
                   <entry>
                     <string>SARWnfAction</string>
                     <container>
                         <maskOneIsValid>false</maskOneIsValid>
                         <pattern>.*([0-9]{8})_([0-9]{6})_.*</pattern>
                         <defaultNameSpace>sde</defaultNameSpace>
                         <defaultNameSpaceURI></defaultNameSpaceURI>
                         <actionClass>it.geosolutions.geobatch.mariss.actions.netcdf.SARWnfAction</actionClass>
                         <params>
                            <entry>
                                <string>NetCDFDir.key</string>
                                <string>data/netcdfdatadir</string>
                            </entry>
                         </params>
                     </container>
                   </entry> 
                   <entry>
                     <string>SARWindAction</string>
                     <container>
                         <maskOneIsValid>false</maskOneIsValid>
                         <pattern>.*([0-9]{8})_([0-9]{6})_.*</pattern>
                         <defaultNameSpace>sde</defaultNameSpace>
                         <defaultNameSpaceURI></defaultNameSpaceURI>
                         <actionClass>it.geosolutions.geobatch.mariss.actions.netcdf.SARWindAction</actionClass>
                         <params>
                            <entry>
                                <string>NetCDFDir.key</string>
                                <string>data/netcdfdatadir</string>
                            </entry>
                         </params>
                     </container>
                   </entry>  
            </subconfigurations>
             <!-- -->
           

        </ProductActionConfiguration>
         
        <CSVIngestConfiguration>
			<id>csv</id>
			<name>CSVIngestion</name>
			<description>Ingest CSV data</description>
			<!-- Connection to the database -->
            <outputFeature>
                <dataStore>
                   <entry>
                     <string>dbtype</string>
                     <string>postgis</string>
                   </entry>
                   <entry>
                     <string>host</string>
                     <string>localhost</string>
                   </entry>
                   <entry>
                     <string>port</string>
                     <string>5432</string>
                   </entry>
                   <entry>
                     <string>database</string>
                     <string>mariss</string>
                   </entry>
                   <entry>
                     <string>schema</string>
                     <string>public</string>
                   </entry>
                   <entry>
                     <string>user</string>
                     <string>mariss</string>
                   </entry>
                   <entry>
                     <string>passwd</string>
                     <string>mariss</string>
                   </entry>
                </dataStore>
            </outputFeature>
            <!-- the CSV separator is common to allow the processor detection based on headers -->
            <csvSeparator>,</csvSeparator>
            <!-- Processors configuration -->
            <proccesorsConfiguration>
            	<CSVProcessorConfiguration>
            		<typeName>products_1to3</typeName>
            		<className>it.geosolutions.geobatch.mariss.ingestion.csv.CSVProductTypes1To3Processor</className>
            		<projection>4326</projection>
            	</CSVProcessorConfiguration>
            	<CSVProcessorConfiguration>
            		<typeName>products_5</typeName>
            		<className>it.geosolutions.geobatch.mariss.ingestion.csv.CSVProductTypes5Processor</className>
            		<projection>4326</projection>
            	</CSVProcessorConfiguration>
            </proccesorsConfiguration>
            
			<!-- Listeners -->
			<listenerId>ConsumerLogger0</listenerId>
			<listenerId>Cumulator</listenerId>
			<listenerId>Status</listenerId>
		</CSVIngestConfiguration>

    </EventConsumerConfiguration>

    <ListenerConfigurations>
        <LoggingProgressListener>
            <serviceID>loggingListenerService</serviceID>
            <id>ConsumerLogger0</id>
            <loggerName>it.geosolutions.ConsLogger</loggerName>
            <appendToListenerForwarder>true</appendToListenerForwarder>
        </LoggingProgressListener>
        <CumulatingProgressListener>
            <serviceID>cumulatingListenerService</serviceID>
            <id>Cumulator</id>
            <appendToListenerForwarder>true</appendToListenerForwarder>
        </CumulatingProgressListener>
    </ListenerConfigurations>

</FlowConfiguration>
